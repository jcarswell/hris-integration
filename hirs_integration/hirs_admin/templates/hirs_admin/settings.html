{% extends "hirs_admin/base.html" %}
{% block content %}
<div class="alert" role="alert"></div>
<div class="row" style="padding:0 1.5rem">
  <div data-spy="scroll" data-target="#page-nav" data-offset="0" class="scrollspy-example container col-md-10 order-md-2">
    <div data-spy="scroll" data-target="#page-nav" data-offset="0" class="scrollspy-example">
      <form>
        {% csrf_token %}
        {{ settings.as_html }}
        <button type="submit" class="btn btn-primary">submit</button>
      </form>
    </div>
  </div>
  <div id="page-nav" class="list-group col-md-2 order-md-1 mb-2">
    {{ settings.as_nav }}
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/bootstrap-show-password@1.2.1/dist/bootstrap-show-password.min.js" inetgrity="sha384-KbjtsG2/8FseXr/pG6hEWL1vE9vDr4gxEGtXWMK8T6D9fb83Nq+Ka0FiwxUSskvd" crossorigin="anonymous"></script>
<script type="text/javascript">
var startItems

function hashDiff(h1,h2){var d={};for(var k in h2){if(h1[k]!==h2[k])d[k]=h2[k];}return d;}
function convertSerializedArrayToHash(a){var r={};for(var i=0;i<a.length;i++){r[a[i].name]=a[i].value;}return r;}
$(function() {
  const csrftoken = Cookies.get('csrftoken');
  var $form = $('form');
  var startItems = convertSerializedArrayToHash($form.serializeArray()); 
});
$(body).scrollspy({ target: '#page-nav' });
$("form").submit(function(e) {
  e.preventDefault();
  var data = hashDiff(startItems,convertSerializedArrayToHash($form.serializeArray()));
  data["csrfmiddlewaretoken"] = csrftoken
  
  $('.alert').dismiss;
  $('.alert').class("alert");

  $.ajax({
    type: "POST",
    url: location.href,
    data: data,
    datatype: "json"
  })
  .done(function(data) {
    if (data["status"] != "success") {
      $('.alert').text(data["message"]);
      $('.alert').alert();
      $('.alert').addClass("alert-danger");
      for(f in data["feilds"]){$('#'+f).addClass("is-invalid");}
    } else {
      $('.alert').text("Success");
      $('.alert').alert();
      $('.alert').addClass("alert-sucess");
      startItems = convertSerializedArrayToHash($form.serializeArray());
      $('.is-invalid').removeClass("is-invalid");
    }
  })
  .error(function(jqXHR,status,error) {
    $('.alert').text("A Server error occured: " + status);
    $('.alert').alert();
    $('.alert').addClass("alert-danger");
  });
});
</script>
{% endblock %}